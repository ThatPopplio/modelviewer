<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VR Scene</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.139.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.139.0/examples/jsm/libs/stats.module.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.139.0/examples/jsm/webxr/VRButton.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: white; }
    canvas { display: block; }
  </style>
</head>
<body>
  <script>
    let camera, scene, renderer;
    let player = new THREE.Object3D();
    let velocityY = 0;
    let isGrounded = false;

    const moveSpeed = 0.05;
    const gravity = -0.01;
    const jumpStrength = 0.25;

    let xrSession = null;
    let referenceSpace = null;

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff); // White background

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      document.body.appendChild(VRButton.createButton(renderer));

      // Player wrapper to move the camera
      player.add(camera);
      scene.add(player);

      const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.5);
      scene.add(light);

      // Ground
      const groundGeo = new THREE.PlaneGeometry(100, 100);
      const groundMat = new THREE.MeshStandardMaterial({ color: 0x00ff00 }); // green
      const ground = new THREE.Mesh(groundGeo, groundMat);
      ground.rotation.x = -Math.PI / 2;
      scene.add(ground);

      // Cube for reference
      const boxGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5);
      const boxMat = new THREE.MeshStandardMaterial({ color: 0x0000ff });
      const box = new THREE.Mesh(boxGeo, boxMat);
      box.position.set(0, 0.25, -2);
      scene.add(box);

      // On session start
      renderer.xr.addEventListener('sessionstart', (e) => {
        xrSession = renderer.xr.getSession();
        xrSession.requestReferenceSpace('local-floor').then((refSpace) => {
          referenceSpace = refSpace;
        });
      });

      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render(timestamp, frame) {
      if (xrSession && frame && referenceSpace) {
        const inputSources = xrSession.inputSources;
        inputSources.forEach(source => {
          if (source && source.gamepad && source.handedness === "left") {
            const axes = source.gamepad.axes;
            const forward = -axes[3] || 0;
            const strafe = axes[2] || 0;

            const referencePose = frame.getViewerPose(referenceSpace);
            if (referencePose) {
              const headsetMatrix = new THREE.Matrix4().fromArray(referencePose.views[0].transform.matrix);
              const direction = new THREE.Vector3(0, 0, -1).applyMatrix4(headsetMatrix).sub(new THREE.Vector3().setFromMatrixPosition(headsetMatrix)).normalize();
              const right = new THREE.Vector3().crossVectors(direction, new THREE.Vector3(0, 1, 0)).normalize();

              const moveVec = new THREE.Vector3();
              moveVec.addScaledVector(direction, forward);
              moveVec.addScaledVector(right, strafe);
              moveVec.multiplyScalar(moveSpeed);

              player.position.add(moveVec);
            }
          }

          // Jumping with A button (button[0])
          if (source && source.gamepad && source.handedness === "right") {
            const buttons = source.gamepad.buttons;
            if (buttons[0].pressed && isGrounded) {
              velocityY = jumpStrength;
              isGrounded = false;
            }
          }
        });
      }

      // Gravity
      velocityY += gravity;
      player.position.y += velocityY;

      if (player.position.y <= 0) {
        player.position.y = 0;
        velocityY = 0;
        isGrounded = true;
      }

      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
